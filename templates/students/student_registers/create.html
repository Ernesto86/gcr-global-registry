{% extends 'v2/base/crud/form/form.html' %}

{% block base-body-js %}

    <script>
        const objElevate = {
            studentId: '{{ student_id }}',
            successUrl: '{{ success_url }}'
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function (e) {
            const objD = {
                CONSTANT: {},
                elem: {
                    $form: document.getElementById('id-form'),
                },
                repeat: {},
                loadFirst: {},
                model: {},
                fun: {
                    submit: async () => {
                        const formData = new FormData(objD.elem.$form)
                        formData.append("action", 'add')
                        formData.append("student_id", objElevate.studentId)

                        AppSystem.fun.showLoadingUi()
                        AppSystem.handleComp.alert.alert.hidden({})

                        const {code, message, data, ...stateExtra} = await ClientHttpFetch.exec(
                            location.pathname,
                            formData
                        )

                        AppSystem.fun.hiddenLoadingUi()

                        if (ErrorResponse.KIND_STATIC === stateExtra.kind) {
                            let errorHtml = '<ul class="ms-5 d-block">'
                            FormCommon.fun.getErrorList(data?.errors).map(elem => `<li>${elem}</li>`)
                            errorHtml += '</ul>'

                            objD.elem.$name.value = data.message
                            AppSystem.handleComp.alert.alert.show({title: message, content: errorHtml, typeFeature: AppSystem.CONSTANT.typeFeature.danger})
                            return
                        }

                        window.location = objElevate.successUrl
                    }
                }
            }

            ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            ///////////////////////////////////////////////  CARGA DEFECTO  ///////////////////////////////////////////////////

            ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            ///////////////////////////////////////////////  EVENTOS  /////////////////////////////////////////////////////////
            objD.elem.$form.addEventListener('submit', (e) => {
                e.preventDefault()

                objD.fun.submit()
            })

        });
    </script>
{% endblock %}


{% block jscript-2 %}
    <script>
        const form = document.getElementById('id-form')
        const c = console.log

        const objElevate = {
            student_id: '{{ student_id }}',
            success_url: '{{ success_url }}'
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            form.classList.add('was-validated');
            if (form.checkValidity() === false) {
                e.preventDefault();
                e.stopPropagation();
            } else {

                const formData = new FormData(form)
                formData.append("action", 'add')
                formData.append("student_id", objElevate.student_id)

                const [status, json] = await mFetch(`{{ request.path }}`, formData, 'POST');

                if (status !== 200) {

                    alert.innerText = json.errors.join(',');
                    alert.classList.remove('d-none');

                    return console.log(json)
                }

                window.location = objElevate.success_url
            }
        })


        {% if messages %}
            {% for message in messages %}
                {% if message.tags.lower == 'success' %}
                    fnToast("{{ message }}");
                {% endif %}
            {% endfor %}
        {% endif %}

    </script>
{% endblock %}
